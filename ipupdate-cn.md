# 动态 DNS 更新工具 - ipupdate

## 项目介绍

ipupdate 是一个轻量级的动态 DNS（DDNS）更新工具，专为需要自动同步本地 IP 地址与
DNS 服务提供商的用户设计。该工具能够自动检测当前公网 IP 地址，并在 IP
发生变化时及时更新对应的 DNS
记录，确保域名始终指向正确的服务器地址。无论是家庭服务器、个人网站还是远程访问服务，ipupdate
都能提供稳定可靠的动态域名解析支持。

本项目的设计理念是简单易用与功能强大的完美结合。用户只需进行简单的配置，即可实现
IP 地址的自动监控与更新，无需人工干预即可保持 DNS
记录的实时准确性。工具采用高效的资源占用设计，能够在树莓派、VPS、低功耗服务器等各类设备上稳定运行，是自托管爱好者和系统管理员的理想选择。

## 主要特性

### 广泛的协议支持

ipupdate 同时支持 IPv4 和 IPv6
两种网络协议，能够适应不同的网络环境需求。对于同时使用双栈网络的用户，工具可以分别对
A 记录（IPv4）和 AAAA
记录（IPv6）进行独立管理，确保在各种网络配置下都能正常工作。这种双栈支持能力使得
ipupdate 在当前网络基础设施过渡期间具有重要的实用价值，能够满足从纯 IPv4 到纯
IPv6 以及混合网络环境的多样化需求。

### 多服务商兼容

工具内置了对主流 DNS 服务提供商的支持，包括但不限于 Cloudflare、阿里云
DNS、腾讯云 DNSPod 等知名平台。每种服务提供商都经过详细的 API
适配测试，确保更新操作的稳定性和可靠性。用户可以根据自己的实际需求选择合适的服务商，或者在多个服务商之间灵活切换，无需修改核心代码即可实现配置变更。

### 灵活的代理支持

针对位于企业防火墙后或需要通过代理访问互联网的网络环境，ipupdate
提供了完善的代理支持机制。工具支持 SOCKS5 代理和 HTTP
代理两种常见代理协议，用户可以在配置文件中轻松指定代理服务器地址和认证信息。这一特性极大地扩展了工具的适用范围，使其能够应对各种复杂的网络拓扑结构。

### 智能更新机制

ipupdate 采用智能的更新策略来优化 DNS 记录管理。工具会定期检测当前公网 IP
地址，并与本地缓存的记录进行比对，仅在确认 IP
发生实际变化时才发起更新请求。这种设计不仅能够有效减少 API
调用次数，降低被服务商限流的风险，同时也能显著延长设备使用寿命和节省网络带宽资源。

### 完善的容错处理

工具内置了多层次的错误处理和恢复机制。当网络连接出现问题、API
调用失败或服务商返回异常响应时，ipupdate
会自动记录详细错误信息，并根据预设策略进行重试操作。工具还支持将更新日志输出到文件或外部日志系统，方便用户进行问题排查和运行状态监控。

## 技术架构

### 核心实现

ipupdate 采用 TypeScript
作为主要开发语言，充分利用其静态类型检查和面向对象特性来保证代码质量和可维护性。项目的编译目标为现代
JavaScript 运行时环境，确保在 Node.js
平台上具有优秀的执行效率和广泛的兼容性。TypeScript
的使用使得代码结构清晰，逻辑分明，便于社区贡献者参与开发和维护。

工具的架构设计遵循模块化原则，将网络请求处理、配置解析、IP
检测、记录更新等功能拆分为独立模块，每个模块职责单一，接口清晰。这种设计不仅提高了代码的可测试性，也为后续功能扩展和定制化开发提供了良好的基础。用户可以根据需要替换或增强特定模块的实现，满足个性化的使用场景。

### 依赖管理

项目依赖经过精心选择，主要包括以下核心依赖组件：用于发起 HTTP 请求的 Axios
库提供了稳定可靠的网络通信能力；用于配置文件解析的对应模块确保了配置加载的灵活性和类型安全性；日志处理模块则为运行状态监控和问题诊断提供了必要的支持。所有依赖都经过版本锁定，确保构建过程的可重复性和部署环境的一致性。

### 运行环境要求

运行 ipupdate 需要以下基础环境：Node.js 运行时环境（建议版本 16.0.0 以上），NPM
或 Yarn 包管理器，以及稳定的网络连接以访问 DNS 服务商的 API 端点。对于 Docker
部署方式，项目提供了预构建的容器镜像，用户无需手动安装 Node.js
环境即可快速启动使用。

## 安装部署

### 通过 NPM 全局安装

对于熟悉 Node.js 生态系统的用户，推荐使用 NPM 进行全局安装。这种方式能够将
ipupdate
作为系统命令直接使用，便于在系统层面配置定时任务和开机自启动。安装过程简单直接，只需执行一条命令即可完成所有依赖的自动下载和配置。

```bash
npm install -g ipupdate
```

安装完成后，可以通过 `ipupdate --help`
命令验证安装是否成功，并查看可用的命令行参数和使用方法。如果在安装过程中遇到权限问题，可能需要使用
sudo 权限或在 Node.js 版本管理器（如 nvm）的环境下进行安装。

### 从源码编译安装

对于需要自定义配置或参与项目开发的用户，可以从源码进行编译安装。首先需要克隆项目仓库到本地，然后安装项目依赖，最后根据需要进行
TypeScript
编译。这种方式给予用户最大的灵活性，可以根据具体需求修改源代码或调整编译配置。

```bash
git clone https://gitlab.com/masx200/ipupdate.git
cd ipupdate
npm install
npm run build
```

编译完成后，可执行文件通常位于 `dist` 目录下。用户可以直接运行编译后的
JavaScript 文件，或者将相关路径添加到系统 PATH
环境变量中，以便在任意位置都能调用 ipupdate 命令。

### Docker 容器部署

对于追求环境一致性和部署便捷性的用户，ipupdate 提供了 Docker
容器化部署方案。容器部署方式将所有运行时依赖封装在镜像中，消除了环境差异带来的潜在问题，同时也简化了跨平台迁移和扩容操作。

```bash
docker pull masx200/ipupdate:latest
docker run -d \
  --name ipupdate \
  -v /path/to/config:/app/config \
  masx200/ipupdate:latest
```

使用 Docker
部署时，建议将配置文件挂载到容器外部，这样可以方便地进行配置修改而无需重建容器。对于需要查看运行日志的用户，可以配置日志卷挂载或使用
Docker 日志收集机制。

## 配置指南

### 配置文件结构

ipupdate 使用 JSON 格式的配置文件来管理各项参数。配置文件通常命名为
`config.json`，包含服务商配置、记录设置、更新策略等核心参数。良好的配置文件结构不仅便于阅读和编辑，也为自动化配置管理提供了可能。

一个典型的配置文件结构如下所示，包含了使用 Cloudflare 服务商时所需的各项配置：

```json
{
  "provider": {
    "name": "cloudflare",
    "api_token": "your_api_token_here",
    "email": "your_email@example.com",
    "proxy": {
      "enabled": false,
      "host": "127.0.0.1",
      "port": 1080,
      "type": "socks5"
    }
  },
  "record": {
    "zone_id": "your_zone_identifier",
    "record_name": "home.example.com",
    "record_type": "A",
    "ttl": 1,
    "proxied": false
  },
  "update": {
    "interval": 300,
    "ipv4_url": "https://api.ipify.org",
    "ipv6_url": "https://api64.ipify.org"
  },
  "logging": {
    "level": "info",
    "file": "/var/log/ipupdate.log"
  }
}
```

### 服务商配置详解

每种 DNS 服务商都有其特定的认证方式和 API 端点要求。Cloudflare 服务商使用 API
令牌进行身份验证，用户需要在 Cloudflare 官网生成具有 DNS 编辑权限的令牌。阿里云
DNS 服务商则使用 AccessKey ID 和 AccessKey Secret
进行认证，这些凭证可以在阿里云控制台的安全设置页面获取。DNSPod
服务商同样采用类似的密钥认证方式，用户需要在腾讯云控制台创建并管理 API 密钥。

在配置代理设置时，需要注意代理服务器的类型选择和认证信息填写。SOCKS5
代理通常用于需要完整 TCP 连接的场景，而 HTTP 代理则更适合简单的 HTTP
请求转发。如果代理服务器需要身份验证，务必在配置中正确填写用户名和密码，否则将无法建立有效的代理连接。

### 记录更新策略配置

IP 检测和更新策略的配置直接影响工具的运行行为和网络资源消耗。`interval`
参数控制两次 IP 检测之间的间隔时间，单位为秒。较短的间隔能够更快地发现 IP
变化，但也会产生更多的 API
调用和潜在的服务商限流风险。建议根据实际需求和网络环境选择合适的间隔值，通常 300
秒（5 分钟）是一个平衡响应速度和资源消耗的合理选择。

IP 检测使用的外部服务 URL 可以通过 `ipv4_url` 和 `ipv6_url` 参数进行自定义。这些
URL 需要能够返回纯文本格式的公网 IP 地址。常用的 IPv4 检测服务包括
ipify.org、icanhazip.com 等，IPv6 检测则可以使用相应的 IPv6
端点。如果用户需要绕过特定的检测服务，也可以部署自有的 IP
检测服务并在这里配置相应地址。

## 使用方法

### 命令行参数

ipupdate
提供了丰富的命令行参数来满足不同的使用场景。主命令可以直接执行，此时工具会按照配置文件中的设置进行单次
IP
检测和更新操作。对于需要持续运行的场景，可以使用守护进程模式让工具在后台自动执行定期检查。

以下是常用的命令行参数说明：

- `--config, -c`：指定配置文件路径，默认为当前目录下的 `config.json`
- `--daemon, -d`：以守护进程模式运行，持续执行定期检测
- `--verbose, -v`：启用详细输出模式，显示更多调试信息
- `--once`：执行单次检测和更新后立即退出，适合定时任务使用
- `--version`：显示工具版本信息
- `--help`：显示帮助信息和可用参数

### 守护进程模式

以守护进程模式运行时，ipupdate 会按照配置文件中指定的间隔时间持续检测 IP
变化。这种模式适合需要长期稳定运行的生产环境，如家庭服务器或企业自托管服务。用户可以使用系统服务管理工具（如
systemd）将 ipupdate 配置为开机自启动服务，确保系统重启后工具能够自动恢复运行。

对于 Docker
部署方式，守护进程模式可以通过容器启动参数或编排配置来实现。大多数容器运行时都支持配置重启策略，用户可以根据需要选择
`always` 或 `unless-stopped` 等策略来保证容器的持续运行。

### 定时任务方式

除了守护进程模式，用户也可以选择通过系统定时任务（如 cron）来周期性地执行
ipupdate。这种方式将工具的执行控制权交给系统调度器，提供了更高的灵活性和资源管理能力。用户可以精确控制执行时间，避开网络高峰期或
API 限流时段。

配置 cron 定时任务的示例如下，该配置会在每 5 分钟执行一次 IP 更新检查：

```bash
*/5 * * * * /usr/local/bin/ipupdate --config /etc/ipupdate/config.json --once >> /var/log/ipupdate.log 2>&1
```

需要注意的是，使用定时任务方式时，应当配置适当的日志记录和错误通知机制，以便及时发现和处理异常情况。建议将错误输出也重定向到日志文件，或配置邮件通知来接收执行失败的告警。

## Docker 编排配置

### docker-compose 配置示例

对于使用 Docker Compose
进行服务管理的用户，以下是一个完整的编排配置示例。该配置定义了一个服务，将配置文件和数据目录挂载到容器外部，配置了重启策略和网络设置。用户可以根据自己的实际环境修改相应的路径和参数。

```yaml
version: "3.8"

services:
  ipupdate:
    image: masx200/ipupdate:latest
    container_name: ipupdate
    restart: unless-stopped
    volumes:
      - ./config:/app/config
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
      - CONFIG_FILE=/app/config/config.json
    networks:
      - default

networks:
  default:
    driver: bridge
```

### 高级配置技巧

在生产环境中，可能需要根据具体需求进行一些高级配置。对于多域名或多记录的管理需求，可以在配置文件中定义多个记录配置，工具会依次处理每个记录的更新操作。如果需要区分不同网络环境的
IP 更新，也可以在配置中使用环境变量来实现条件配置。

对于高可用部署场景，可以考虑使用多个 ipupdate 实例同时运行，每个实例连接到不同的
DNS 服务商或使用不同的 API
凭证。这种冗余设计能够在单一服务商出现问题时提供故障转移能力，确保域名解析服务的高可用性。

## 日志与监控

### 日志级别配置

ipupdate 支持多种日志级别，用户可以根据需要选择合适的日志详细程度。`debug`
级别会输出最详细的执行信息，包括每个网络请求的详细内容，适合开发调试和问题排查。`info`
级别提供常规的运行状态信息，能够满足大多数监控需求。`warn` 和 `error`
级别则分别用于记录警告和错误信息，适合在生产环境中减少日志量。

日志输出支持控制台和文件两种目的地。控制台输出对于开发测试和交互式使用非常方便，而文件输出则更适合需要长期保存日志的生产环境。可以通过配置文件分别设置日志级别和输出目标，实现灵活的日志管理策略。

### 状态监控集成

对于需要将 ipupdate
运行状态集成到现有监控系统的用户，工具提供了多种监控集成方式。可以通过读取日志文件来获取运行状态信息，也可以配置工具将状态数据输出到监控系统支持的格式。部分用户还通过健康检查接口或自定义脚本实现与其他监控平台的集成。

建议在监控系统中配置以下关键指标的监控：最后成功更新的时间戳、API
调用失败次数、IP
变化检测次数等。这些指标能够帮助管理员及时发现潜在问题，评估工具的运行健康状况。

## 故障排查

### 常见问题处理

在使用 ipupdate
的过程中，可能会遇到一些常见问题。当工具报告认证失败时，首先应当检查配置文件中的
API 凭证是否正确，确保凭证具有相应的 DNS 编辑权限。对于 Cloudflare
服务商，还需要确认令牌的作用域设置是否包含目标域名的 DNS 管理权限。

网络连接问题通常表现为超时错误或无法解析域名。这种情况下可以检查代理配置是否正确，网络连接是否稳定，以及
DNS 服务商的 API 端点是否可达。如果使用了自定义的 IP 检测
URL，需要确认该服务是否能够正常访问并返回正确的 IP 地址格式。

### 调试模式使用

当遇到复杂问题时，可以启用详细输出模式来获取更多的调试信息。在调试模式下，工具会输出每个步骤的详细执行情况，包括网络请求的请求头、响应状态码、响应体等内容。这些信息对于定位问题根因非常有价值，建议在问题排查时首先启用调试模式收集完整的执行日志。

如果调试日志中显示 API 调用失败但没有明确的错误原因，可以尝试使用外部工具（如
curl）直接测试 API
端点的可达性和认证信息是否正确。这种方法能够帮助快速排除网络层面的问题，缩小问题定位的范围。

## 贡献指南

### 参与开发

ipupdate
项目欢迎社区贡献者参与开发和完善。在开始贡献之前，建议先阅读项目的贡献指南文档，了解代码规范、测试要求以及提交请求的流程。项目的代码库托管在
GitLab 上，开发者可以通过 Fork 和 Merge Request 的方式提交代码改进。

对于新功能开发或重大修改，建议在实施前先在项目的 Issue
讨论区发起讨论，与维护者和其他贡献者沟通设计方案和实现思路。这种开放式协作方式能够确保开发工作与项目整体方向保持一致，也能获得来自社区的宝贵意见和建议。

### 问题反馈

当发现工具存在缺陷或功能缺失时，欢迎通过 GitLab 的 Issue
系统提交问题报告。为了帮助维护者更快地定位和解决问题，建议在报告中详细描述问题现象、复现步骤、环境配置等信息。如果是已知问题，可以先搜索现有
Issue 确认是否已有相关讨论，避免重复提交。

对于安全相关的漏洞报告，请通过项目的安全联系方式私下报告，不要在公开渠道披露漏洞细节。项目维护者会尽快对安全报告进行评估和响应，并协调发布相应的安全修复版本。

## 许可证

ipupdate 项目采用 MIT 许可证进行开源授权。这意味着用户可以自由地使用、修改和分发
